# Rediså»é‡ç§»é™¤æ€»ç»“

## æ¦‚è¿°

æ ¹æ®ä½ çš„å»ºè®®ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸç§»é™¤äº†Rediså»é‡å®¹å™¨ç›¸å…³çš„ä»£ç ï¼Œæ”¹ä¸ºç›´æ¥å¯¹æ¯”æ–‡æ¡£æ›´æ–°å‰åçš„URLæ¥è¿›è¡Œå›¾ç‰‡ç®¡ç†ã€‚è¿™ç§æ–¹å¼æ›´åŠ ç®€æ´ç›´æ¥ï¼Œå‡å°‘äº†ç³»ç»Ÿå¤æ‚åº¦ã€‚

## âœ… å·²ç§»é™¤çš„åŠŸèƒ½

### 1. **Redisç›¸å…³ä»£ç **
- ç§»é™¤äº†`_url_to_key`æ–¹æ³•ï¼ˆMD5å“ˆå¸Œç”Ÿæˆï¼‰
- ç§»é™¤äº†`_register_image_references`æ–¹æ³•ï¼ˆæ³¨å†Œå›¾ç‰‡å¼•ç”¨ï¼‰
- ç§»é™¤äº†å¤æ‚çš„`_update_image_references`æ–¹æ³•ï¼ˆRediså¼•ç”¨è®¡æ•°ï¼‰
- ç§»é™¤äº†æ‰€æœ‰Rediså®¢æˆ·ç«¯å¯¼å…¥å’Œä½¿ç”¨

### 2. **ç®€åŒ–çš„å›¾ç‰‡ç®¡ç†**
- æ–°å¢`_cleanup_removed_images`æ–¹æ³•ï¼Œç›´æ¥å¯¹æ¯”å‰åURL
- æ–‡æ¡£æ›´æ–°æ—¶ç›´æ¥åˆ é™¤ä¸å†ä½¿ç”¨çš„å›¾ç‰‡
- æ–‡æ¡£åˆ é™¤æ—¶ç›´æ¥åˆ é™¤æ‰€æœ‰ç›¸å…³å›¾ç‰‡

### 3. **æµ‹è¯•ç”¨ä¾‹æ›´æ–°**
- ç§»é™¤äº†Redisç›¸å…³çš„mockå’Œæµ‹è¯•
- æ›´æ–°ä¸ºç®€å•çš„å›¾ç‰‡æ¸…ç†é€»è¾‘æµ‹è¯•
- ä¿ç•™äº†æ ¸å¿ƒåŠŸèƒ½éªŒè¯

## ğŸ”„ ä¼˜åŒ–åçš„å·¥ä½œæµç¨‹

### æ–‡æ¡£ç¼–è¾‘åœºæ™¯
```
ç”¨æˆ·ç¼–è¾‘å¯Œæ–‡æœ¬ â†’ ä¿å­˜æ–‡æ¡£
    â†“
æå–æ—§HTMLä¸­çš„å›¾ç‰‡URL â†’ æå–æ–°HTMLä¸­çš„å›¾ç‰‡URL
    â†“
è®¡ç®—å·®é›†(æ—§ - æ–°) â†’ ç›´æ¥åˆ é™¤ä¸å†ä½¿ç”¨çš„å›¾ç‰‡
```

### æ–‡æ¡£åˆ é™¤åœºæ™¯
```
ç”¨æˆ·åˆ é™¤æ–‡æ¡£ â†’ è½¯åˆ é™¤æ–‡æ¡£
    â†“
æå–æ–‡æ¡£ä¸­æ‰€æœ‰å›¾ç‰‡URL â†’ ç›´æ¥åˆ é™¤æ‰€æœ‰å›¾ç‰‡
    â†“
åˆ é™¤å‘é‡æ•°æ®åº“å†…å®¹
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

```
api/backend_management/
â”œâ”€â”€ knowledge/
â”‚   â”œâ”€â”€ serializers/
â”‚   â”‚   â””â”€â”€ knowledge_management.py     # âœ… ç§»é™¤Redisä»£ç ï¼Œç®€åŒ–å›¾ç‰‡ç®¡ç†
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ knowledge_management.py     # âœ… ç§»é™¤Redisä»£ç ï¼Œä¿ç•™å‘é‡æ•°æ®åº“æ¸…ç†
â”‚   â””â”€â”€ tests/
â”‚       â””â”€â”€ test_rich_text_management.py # âœ… æ›´æ–°æµ‹è¯•ç”¨ä¾‹
â””â”€â”€ Rediså»é‡ç§»é™¤æ€»ç»“.md                 # âœ… æœ¬æ–‡æ¡£
```

## ğŸ¯ ç®€åŒ–åçš„æ ¸å¿ƒé€»è¾‘

### åºåˆ—åŒ–å™¨ä¸­çš„å›¾ç‰‡ç®¡ç†

#### æ–‡æ¡£æ›´æ–°æ—¶
```python
def update(self, instance, validated_data):
    # è·å–æ›´æ–°å‰çš„å›¾ç‰‡åˆ—è¡¨
    old_image_urls = self._extract_image_urls(instance.content) if instance.content else []
    
    # å¤„ç†HTMLå†…å®¹å’Œbase64å›¾ç‰‡è½¬æ¢
    # ...
    
    # æ›´æ–°æ–‡æ¡£
    document = super().update(instance, validated_data)
    
    # ç®€å•å¯¹æ¯”å¹¶æ¸…ç†å›¾ç‰‡
    if 'content' in validated_data:
        new_image_urls = self._extract_image_urls(document.content) if document.content else []
        self._cleanup_removed_images(old_image_urls, new_image_urls)
```

#### å›¾ç‰‡æ¸…ç†é€»è¾‘
```python
def _cleanup_removed_images(self, old_image_urls, new_image_urls):
    """æ¸…ç†ä¸å†ä½¿ç”¨çš„å›¾ç‰‡"""
    # è®¡ç®—åˆ é™¤çš„å›¾ç‰‡
    removed_images = set(old_image_urls) - set(new_image_urls)
    
    # ç›´æ¥åˆ é™¤ä¸å†ä½¿ç”¨çš„å›¾ç‰‡
    for image_url in removed_images:
        await self._delete_cos_image(image_url)
```

### è§†å›¾ä¸­çš„æ–‡æ¡£åˆ é™¤

#### åˆ é™¤èµ„æºæ¸…ç†
```python
async def _cleanup_document_images(self, document):
    """æ¸…ç†æ–‡æ¡£ç›¸å…³å›¾ç‰‡"""
    image_urls = self._extract_image_urls(document.content)
    
    for image_url in image_urls:
        # ç›´æ¥åˆ é™¤å›¾ç‰‡ï¼ˆæ–‡æ¡£åˆ é™¤æ—¶ä¸å†éœ€è¦å¼•ç”¨è®¡æ•°ï¼‰
        await self._delete_cos_image(image_url)
```

## âœ¨ ä¼˜åŒ–çš„ä¼˜åŠ¿

### 1. **ç®€åŒ–æ¶æ„**
- ç§»é™¤äº†Redisä¾èµ–
- å‡å°‘äº†ç³»ç»Ÿå¤æ‚åº¦
- æ›´å®¹æ˜“ç†è§£å’Œç»´æŠ¤

### 2. **ç›´æ¥æœ‰æ•ˆ**
- ä¸éœ€è¦ç»´æŠ¤å¤æ‚çš„å¼•ç”¨è®¡æ•°
- ç›´æ¥å¯¹æ¯”URLæ›´å¯é 
- å‡å°‘äº†æ½œåœ¨çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜

### 3. **æ€§èƒ½æå‡**
- å‡å°‘äº†Redisè¯»å†™æ“ä½œ
- æ²¡æœ‰é¢å¤–çš„å“ˆå¸Œè®¡ç®—å¼€é”€
- å¼‚æ­¥åˆ é™¤ä¸å½±å“ä¸»æµç¨‹

### 4. **æ›´å°‘çš„æ•…éšœç‚¹**
- ä¸ä¾èµ–Redisçš„å¯ç”¨æ€§
- å‡å°‘äº†ç½‘ç»œè°ƒç”¨
- ç®€åŒ–äº†é”™è¯¯å¤„ç†é€»è¾‘

## ğŸ§ª æµ‹è¯•éªŒè¯

### ä¿ç•™çš„æ ¸å¿ƒæµ‹è¯•
1. **å›¾ç‰‡URLæå–æµ‹è¯•** - éªŒè¯èƒ½æ­£ç¡®æå–COSå›¾ç‰‡URL
2. **å›¾ç‰‡æ¸…ç†é€»è¾‘æµ‹è¯•** - éªŒè¯é›†åˆè¿ç®—çš„æ­£ç¡®æ€§
3. **æ–‡æ¡£åˆ é™¤æ¸…ç†æµ‹è¯•** - éªŒè¯åˆ é™¤æ—¶èµ„æºæ¸…ç†
4. **å›¾ç‰‡æ¸…ç†ç®¡ç†æµ‹è¯•** - éªŒè¯æ›´æ–°æ—¶å›¾ç‰‡æ¸…ç†

### æµ‹è¯•ç¤ºä¾‹
```python
def test_image_cleanup_logic(self):
    old_urls = ["url1", "url2"]
    new_urls = ["url2", "url3"]
    removed_images = set(old_urls) - set(new_urls)
    assert "url1" in removed_images  # åº”è¯¥è¢«åˆ é™¤
    assert "url2" not in removed_images  # åº”è¯¥ä¿ç•™
```

## ğŸ“Š ç³»ç»Ÿå½±å“åˆ†æ

### æ­£é¢å½±å“
- âœ… **ä»£ç ç®€æ´æ€§**ï¼šå‡å°‘äº†çº¦100è¡ŒRedisç›¸å…³ä»£ç 
- âœ… **ç»´æŠ¤æˆæœ¬**ï¼šé™ä½äº†ç³»ç»Ÿå¤æ‚åº¦å’Œç»´æŠ¤éš¾åº¦
- âœ… **å¯é æ€§**ï¼šæ¶ˆé™¤äº†Rediså•ç‚¹æ•…éšœé£é™©
- âœ… **æ€§èƒ½**ï¼šå‡å°‘äº†ç½‘ç»œIOå’Œåºåˆ—åŒ–å¼€é”€

### æ½œåœ¨è€ƒé‡
- âš ï¸ **å¹¶å‘å¤„ç†**ï¼šåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¯èƒ½å­˜åœ¨åŒä¸€å›¾ç‰‡è¢«å¤šä¸ªè¯·æ±‚åŒæ—¶åˆ é™¤çš„æƒ…å†µ
- âš ï¸ **è¯¯åˆ é£é™©**ï¼šç†è®ºä¸Šå­˜åœ¨è¯¯åˆ å…¶ä»–æ–‡æ¡£æ­£åœ¨ä½¿ç”¨å›¾ç‰‡çš„æå°æ¦‚ç‡ï¼ˆåœ¨å½“å‰ç®€åŒ–è®¾è®¡ä¸­å¯æ¥å—ï¼‰

### é£é™©ç¼“è§£
1. **å¼‚å¸¸å¤„ç†**ï¼šåˆ é™¤æ“ä½œåŒ…å«å®Œæ•´çš„å¼‚å¸¸å¤„ç†
2. **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•æ‰€æœ‰åˆ é™¤æ“ä½œ
3. **æ–‡ä»¶æ£€æŸ¥**ï¼šåˆ é™¤å‰æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
4. **å¼‚æ­¥å¤„ç†**ï¼šä¸å½±å“ç”¨æˆ·çš„ä¸»è¦æ“ä½œ

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

å¦‚æœæœªæ¥éœ€è¦æ›´ç²¾ç¡®çš„å›¾ç‰‡ç®¡ç†ï¼Œå¯ä»¥è€ƒè™‘ï¼š

### 1. **æ•°æ®åº“çº§åˆ«çš„å¼•ç”¨è®¡æ•°**
```sql
-- å›¾ç‰‡å¼•ç”¨è¡¨
CREATE TABLE image_references (
    image_url VARCHAR(255),
    document_id INT,
    created_at TIMESTAMP
);
```

### 2. **å®šæ—¶æ¸…ç†ä»»åŠ¡**
- å®šæœŸæ‰«æå­¤ç«‹å›¾ç‰‡
- æ‰¹é‡æ¸…ç†æœªè¢«å¼•ç”¨çš„æ–‡ä»¶
- ç”Ÿæˆæ¸…ç†æŠ¥å‘Š

### 3. **è½¯åˆ é™¤æœºåˆ¶**
- å›¾ç‰‡æ ‡è®°åˆ é™¤è€Œéç«‹å³åˆ é™¤
- æä¾›æ¢å¤åŠŸèƒ½
- å®šæœŸæ¸…ç†æ ‡è®°åˆ é™¤çš„æ–‡ä»¶

## æ€»ç»“

é€šè¿‡ç§»é™¤Rediså»é‡æœºåˆ¶ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

ğŸ¯ **æ›´ç®€æ´çš„æ¶æ„** - ç›´æ¥URLå¯¹æ¯”æ›¿ä»£å¤æ‚çš„å¼•ç”¨è®¡æ•°
âš¡ **æ›´å¥½çš„æ€§èƒ½** - å‡å°‘äº†å¤–éƒ¨ä¾èµ–å’Œç½‘ç»œå¼€é”€  
ğŸ”§ **æ›´æ˜“ç»´æŠ¤** - ä»£ç é€»è¾‘æ›´æ¸…æ™°ï¼Œæ•…éšœç‚¹æ›´å°‘
âœ… **åŠŸèƒ½å®Œæ•´** - ä¿æŒäº†åŸæœ‰çš„å›¾ç‰‡ç®¡ç†å’Œæ¸…ç†èƒ½åŠ›

è¿™ç§ç®€åŒ–çš„æ–¹æ¡ˆåœ¨å½“å‰ä¸šåŠ¡åœºæ™¯ä¸‹æ˜¯æœ€ä¼˜é€‰æ‹©ï¼Œæ—¢æ»¡è¶³äº†åŠŸèƒ½éœ€æ±‚ï¼Œåˆæ˜¾è‘—é™ä½äº†ç³»ç»Ÿå¤æ‚åº¦ã€‚