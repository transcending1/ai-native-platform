# æœåŠ¡ç«¯ä¼˜åŒ–å¢å¼ºåŠŸèƒ½è¯´æ˜

## æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦è§£å†³äº†ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼šæ–‡æ¡£åˆ é™¤æ—¶çš„å‘é‡æ•°æ®åº“æ¸…ç†ã€å›¾ç‰‡å»é‡æœºåˆ¶ä»¥åŠRediså›¾ç‰‡å¼•ç”¨ç®¡ç†ã€‚è¿™äº›ä¼˜åŒ–æ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§å’Œå­˜å‚¨æ•ˆç‡ã€‚

## ğŸ¯ ä¼˜åŒ–å†…å®¹

### 1. æ–‡æ¡£åˆ é™¤æ—¶å‘é‡æ•°æ®åº“æ¸…ç†

**é—®é¢˜**ï¼šåˆ é™¤æ–‡æ¡£æ—¶åªè¿›è¡Œäº†è½¯åˆ é™¤ï¼Œæ²¡æœ‰æ¸…ç†å‘é‡æ•°æ®åº“ä¸­çš„ç›¸å…³æ•°æ®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨æ–‡æ¡£åˆ é™¤æ—¶åŒæ­¥è°ƒç”¨å‘é‡æ•°æ®åº“çš„åˆ é™¤æ¥å£
- æ”¯æŒé€’å½’åˆ é™¤å­æ–‡æ¡£çš„å‘é‡æ•°æ®
- å¼‚æ­¥å¤„ç†ï¼Œä¸å½±å“åˆ é™¤æ“ä½œæ€§èƒ½

**å®ç°ä½ç½®**ï¼š`knowledge/views/knowledge_management.py`

```python
async def _cleanup_documents_resources(self, documents):
    """æ¸…ç†æ–‡æ¡£ç›¸å…³èµ„æºï¼ˆå‘é‡æ•°æ®åº“å’Œå›¾ç‰‡ï¼‰"""
    from core.indexing.index import delete as delete_from_vector_db
    
    for doc in documents:
        if doc.is_document and doc.markdown_content:
            await delete_from_vector_db(
                document_id=str(doc.id),
                tenant=str(doc.creator.id),
                namespace=str(doc.namespace.id),
            )
```

### 2. å›¾ç‰‡å»é‡å’Œæ™ºèƒ½æ¸…ç†æœºåˆ¶

**é—®é¢˜**ï¼šå¯Œæ–‡æœ¬ç¼–è¾‘å™¨åˆ é™¤å›¾ç‰‡åï¼ŒCOSæ¡¶ä¸­çš„å›¾ç‰‡æ²¡æœ‰è¢«åˆ é™¤ï¼Œé€ æˆå­˜å‚¨æµªè´¹ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®æ—¶è·Ÿè¸ªå›¾ç‰‡ä¸æ–‡æ¡£çš„å¼•ç”¨å…³ç³»
- å½“å›¾ç‰‡ä¸å†è¢«ä»»ä½•æ–‡æ¡£å¼•ç”¨æ—¶è‡ªåŠ¨åˆ é™¤
- æ”¯æŒæ–‡æ¡£æ›´æ–°æ—¶çš„å¢é‡å›¾ç‰‡ç®¡ç†

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- **å›¾ç‰‡å¼•ç”¨æ³¨å†Œ**ï¼šæ–‡æ¡£åˆ›å»ºæ—¶æ³¨å†Œå›¾ç‰‡å¼•ç”¨
- **å¼•ç”¨æ›´æ–°**ï¼šæ–‡æ¡£ç¼–è¾‘æ—¶åŠ¨æ€æ›´æ–°å¼•ç”¨å…³ç³»
- **è‡ªåŠ¨æ¸…ç†**ï¼šå¼•ç”¨è®¡æ•°ä¸º0æ—¶è‡ªåŠ¨åˆ é™¤å›¾ç‰‡

### 3. Rediså›¾ç‰‡å¼•ç”¨çŠ¶æ€ç®¡ç†

**é—®é¢˜**ï¼šéœ€è¦é«˜æ•ˆçš„å›¾ç‰‡å¼•ç”¨è®¡æ•°å’ŒçŠ¶æ€ç®¡ç†æœºåˆ¶ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨Redis Setæ•°æ®ç»“æ„ç®¡ç†å›¾ç‰‡å¼•ç”¨
- æ¯ä¸ªå›¾ç‰‡å¯¹åº”ä¸€ä¸ªRedisé”®ï¼Œå­˜å‚¨å¼•ç”¨å®ƒçš„æ–‡æ¡£åˆ—è¡¨
- è®¾ç½®è¿‡æœŸæ—¶é—´é˜²æ­¢Rediså†…å­˜æ³„æ¼

**Redisæ•°æ®ç»“æ„**ï¼š
```
image_refs:{image_hash} -> Set{doc:1, doc:2, doc:3}
```

## ğŸ› ï¸ æŠ€æœ¯å®ç°è¯¦æƒ…

### å›¾ç‰‡å¼•ç”¨ç®¡ç†æµç¨‹

#### 1. æ–‡æ¡£åˆ›å»ºæ—¶
```python
def _register_image_references(self, document):
    """æ³¨å†Œæ–‡æ¡£çš„å›¾ç‰‡å¼•ç”¨å…³ç³»"""
    image_urls = self._extract_image_urls(document.content)
    doc_ref_key = f"doc:{document.id}"
    
    for image_url in image_urls:
        image_key = f"image_refs:{self._url_to_key(image_url)}"
        redis_client.sadd(image_key, doc_ref_key)
        redis_client.expire(image_key, 30 * 24 * 3600)  # 30å¤©è¿‡æœŸ
```

#### 2. æ–‡æ¡£æ›´æ–°æ—¶
```python
def _update_image_references(self, document, old_image_urls, new_image_urls):
    """æ›´æ–°æ–‡æ¡£çš„å›¾ç‰‡å¼•ç”¨å…³ç³»"""
    added_images = set(new_image_urls) - set(old_image_urls)
    removed_images = set(old_image_urls) - set(new_image_urls)
    
    # æ·»åŠ æ–°å›¾ç‰‡å¼•ç”¨
    for image_url in added_images:
        # æ³¨å†Œå¼•ç”¨
    
    # ç§»é™¤ä¸å†ä½¿ç”¨çš„å›¾ç‰‡å¼•ç”¨
    for image_url in removed_images:
        # æ£€æŸ¥å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœä¸º0åˆ™åˆ é™¤å›¾ç‰‡
```

#### 3. æ–‡æ¡£åˆ é™¤æ—¶
```python
async def _cleanup_document_images(self, document):
    """æ¸…ç†æ–‡æ¡£ç›¸å…³å›¾ç‰‡"""
    image_urls = self._extract_image_urls(document.content)
    
    for image_url in image_urls:
        redis_client.srem(image_key, doc_ref_key)
        ref_count = redis_client.scard(image_key)
        if ref_count == 0:
            await self._delete_cos_image(image_url)
```

### å›¾ç‰‡URLæå–ç®—æ³•

```python
def _extract_image_urls(self, html_content):
    """ä»HTMLå†…å®¹ä¸­æå–å›¾ç‰‡URL"""
    # åªåŒ¹é…COSå­˜å‚¨çš„å›¾ç‰‡ï¼Œå¿½ç•¥å¤–éƒ¨é“¾æ¥
    pattern = r'<img[^>]*src="([^"]*knowledge/[^"]*)"[^>]*>'
    matches = re.findall(pattern, html_content)
    return matches
```

### URLå“ˆå¸Œç®—æ³•

```python
def _url_to_key(self, url):
    """å°†URLè½¬æ¢ä¸ºRedisé”®"""
    return hashlib.md5(url.encode()).hexdigest()
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶ç»“æ„

```
api/backend_management/
â”œâ”€â”€ knowledge/
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ knowledge_management.py          # âœ… å¢å¼ºæ–‡æ¡£åˆ é™¤é€»è¾‘
â”‚   â”œâ”€â”€ serializers/
â”‚   â”‚   â””â”€â”€ knowledge_management.py          # âœ… å›¾ç‰‡å¼•ç”¨ç®¡ç†
â”‚   â””â”€â”€ tests/
â”‚       â””â”€â”€ test_rich_text_management.py     # âœ… æ–°å¢æµ‹è¯•ç”¨ä¾‹
â””â”€â”€ æœåŠ¡ç«¯ä¼˜åŒ–å¢å¼ºè¯´æ˜.md                      # âœ… æœ¬æ–‡æ¡£
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### 1. Rediså›¾ç‰‡å¼•ç”¨ç®¡ç†æµ‹è¯•
```python
@patch('knowledge.serializers.knowledge_management.redis_client')
def test_image_reference_management(self, mock_redis):
    """æµ‹è¯•Rediså›¾ç‰‡å¼•ç”¨ç®¡ç†"""
    # æ¨¡æ‹Ÿæ–‡æ¡£æ›´æ–°ï¼ŒéªŒè¯Redisæ“ä½œ
```

### 2. æ–‡æ¡£åˆ é™¤æ¸…ç†æµ‹è¯•
```python
@patch('knowledge.views.knowledge_management.delete_from_vector_db')
def test_document_deletion_cleanup(self, mock_vector_delete):
    """æµ‹è¯•æ–‡æ¡£åˆ é™¤æ—¶çš„èµ„æºæ¸…ç†"""
    # éªŒè¯å‘é‡æ•°æ®åº“å’Œå›¾ç‰‡æ¸…ç†
```

### 3. å›¾ç‰‡URLæå–æµ‹è¯•
```python
def test_extract_image_urls(self):
    """æµ‹è¯•å›¾ç‰‡URLæå–åŠŸèƒ½"""
    # éªŒè¯åªæå–COSå›¾ç‰‡ï¼Œå¿½ç•¥å¤–éƒ¨é“¾æ¥
```

## ğŸ”„ å·¥ä½œæµç¨‹ç¤ºä¾‹

### åœºæ™¯1ï¼šç”¨æˆ·ç¼–è¾‘å¯Œæ–‡æœ¬åˆ é™¤å›¾ç‰‡

1. **ç”¨æˆ·æ“ä½œ**ï¼šåœ¨CKEditorä¸­åˆ é™¤ä¸€å¼ å›¾ç‰‡
2. **ç³»ç»Ÿå¤„ç†**ï¼š
   ```
   æ›´æ–°è¯·æ±‚ â†’ æ¯”è¾ƒæ–°æ—§HTML â†’ è¯†åˆ«åˆ é™¤çš„å›¾ç‰‡
      â†“
   Redisç§»é™¤å¼•ç”¨ â†’ æ£€æŸ¥å¼•ç”¨è®¡æ•° â†’ è®¡æ•°ä¸º0ï¼Ÿ
      â†“                              â†“
   ä¿ç•™å›¾ç‰‡ â† No                    Yes â†’ åˆ é™¤COSå›¾ç‰‡
   ```

### åœºæ™¯2ï¼šæ–‡æ¡£åˆ é™¤

1. **ç”¨æˆ·æ“ä½œ**ï¼šåˆ é™¤æ–‡æ¡£
2. **ç³»ç»Ÿå¤„ç†**ï¼š
   ```
   åˆ é™¤è¯·æ±‚ â†’ è½¯åˆ é™¤æ–‡æ¡£ â†’ æ”¶é›†å¾…æ¸…ç†èµ„æº
      â†“
   å¼‚æ­¥æ¸…ç† â†’ åˆ é™¤å‘é‡æ•°æ®åº“ â†’ æ¸…ç†å›¾ç‰‡å¼•ç”¨
      â†“
   æ£€æŸ¥å¼•ç”¨è®¡æ•° â†’ åˆ é™¤æœªè¢«å¼•ç”¨çš„å›¾ç‰‡
   ```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¤„ç†
- å‘é‡æ•°æ®åº“åˆ é™¤æ“ä½œå¼‚æ­¥æ‰§è¡Œ
- å›¾ç‰‡åˆ é™¤æ“ä½œå¼‚æ­¥æ‰§è¡Œ
- ä¸å½±å“ä¸»è¯·æ±‚çš„å“åº”æ—¶é—´

### 2. Redisä¼˜åŒ–
- ä½¿ç”¨Setæ•°æ®ç»“æ„ï¼ŒæŸ¥è¯¢æ•ˆç‡O(1)
- è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- æ‰¹é‡æ“ä½œï¼Œå‡å°‘Redisè®¿é—®æ¬¡æ•°

### 3. å­˜å‚¨ä¼˜åŒ–
- æ™ºèƒ½å›¾ç‰‡æ¸…ç†ï¼Œå‡å°‘å­˜å‚¨æˆæœ¬
- åªå¤„ç†COSå­˜å‚¨çš„å›¾ç‰‡ï¼Œå¿½ç•¥å¤–éƒ¨é“¾æ¥
- åŸºäºMD5å“ˆå¸Œçš„é«˜æ•ˆé”®å€¼ç®¡ç†

## ğŸ”’ å®‰å…¨æ€§è€ƒè™‘

### 1. æƒé™æ§åˆ¶
- åªæœ‰æœ‰æƒé™ç¼–è¾‘æ–‡æ¡£çš„ç”¨æˆ·æ‰èƒ½è§¦å‘å›¾ç‰‡æ¸…ç†
- æ–‡æ¡£åˆ é™¤éœ€è¦ç¼–è¾‘æƒé™éªŒè¯

### 2. æ•°æ®å®‰å…¨
- è½¯åˆ é™¤æœºåˆ¶ï¼Œæ•°æ®å¯æ¢å¤
- Redisæ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´
- å¼‚å¸¸å¤„ç†ï¼Œé˜²æ­¢æ•°æ®ä¸ä¸€è‡´

### 3. å­˜å‚¨å®‰å…¨
- åªåˆ é™¤knowledgeè·¯å¾„ä¸‹çš„å›¾ç‰‡
- æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ï¼Œé˜²æ­¢è¯¯åˆ 
- è¯¦ç»†æ—¥å¿—è®°å½•ï¼Œä¾¿äºè¿½è¸ª

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### 1. å­˜å‚¨æŒ‡æ ‡
- COSå­˜å‚¨ä½¿ç”¨é‡å˜åŒ–
- å›¾ç‰‡æ–‡ä»¶æ•°é‡å˜åŒ–
- å­˜å‚¨æˆæœ¬ä¼˜åŒ–æ•ˆæœ

### 2. æ€§èƒ½æŒ‡æ ‡
- æ–‡æ¡£åˆ é™¤å“åº”æ—¶é—´
- å›¾ç‰‡æ¸…ç†æˆåŠŸç‡
- Redisæ“ä½œå»¶è¿Ÿ

### 3. ä¸šåŠ¡æŒ‡æ ‡
- å‘é‡æ•°æ®åº“æ•°æ®ä¸€è‡´æ€§
- å›¾ç‰‡å¼•ç”¨å‡†ç¡®æ€§
- ç”¨æˆ·æ“ä½œæˆåŠŸç‡

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### 1. æ•°æ®ä¸€è‡´æ€§æå‡
- âœ… æ–‡æ¡£åˆ é™¤æ—¶åŒæ­¥æ¸…ç†å‘é‡æ•°æ®åº“
- âœ… å›¾ç‰‡å¼•ç”¨å…³ç³»å®æ—¶æ›´æ–°
- âœ… å­˜å‚¨æ•°æ®ä¸ä¸šåŠ¡æ•°æ®ä¿æŒä¸€è‡´

### 2. å­˜å‚¨æˆæœ¬ä¼˜åŒ–
- âœ… è‡ªåŠ¨æ¸…ç†æœªä½¿ç”¨çš„å›¾ç‰‡
- âœ… å‡å°‘COSå­˜å‚¨è´¹ç”¨
- âœ… æé«˜å­˜å‚¨åˆ©ç”¨ç‡

### 3. ç³»ç»Ÿæ€§èƒ½æå‡
- âœ… å¼‚æ­¥å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
- âœ… Redisé«˜æ•ˆç¼“å­˜ï¼Œå¿«é€Ÿå“åº”
- âœ… æ™ºèƒ½æ¸…ç†ï¼Œå‡å°‘ç³»ç»Ÿè´Ÿè½½

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### 1. ç›‘æ§å‘Šè­¦
- **å­˜å‚¨ç›‘æ§**ï¼šç›‘æ§COSä½¿ç”¨é‡å’Œè´¹ç”¨å˜åŒ–
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§å›¾ç‰‡æ¸…ç†å’Œå‘é‡æ•°æ®åº“åˆ é™¤æ€§èƒ½
- **å¼‚å¸¸å‘Šè­¦**ï¼šå¯¹æ¸…ç†å¤±è´¥è¿›è¡Œå‘Šè­¦é€šçŸ¥

### 2. æ‰¹é‡ä¼˜åŒ–
- **æ‰¹é‡æ¸…ç†**ï¼šå®šæœŸæ‰«æå’Œæ‰¹é‡æ¸…ç†å­¤ç«‹å›¾ç‰‡
- **æ‰¹é‡åŒæ­¥**ï¼šæ”¯æŒæ‰¹é‡åŒæ­¥å‘é‡æ•°æ®åº“
- **å®šæ—¶ä»»åŠ¡**ï¼šå®šæœŸæ£€æŸ¥Rediså’Œå®é™…å­˜å‚¨çš„ä¸€è‡´æ€§

### 3. åŠŸèƒ½å¢å¼º
- **å›¾ç‰‡ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒå›¾ç‰‡å†å²ç‰ˆæœ¬ç®¡ç†
- **å›æ”¶ç«™æœºåˆ¶**ï¼šæ”¯æŒåˆ é™¤å›¾ç‰‡çš„æ¢å¤åŠŸèƒ½
- **å‹ç¼©ä¼˜åŒ–**ï¼šè‡ªåŠ¨å‹ç¼©å­˜å‚¨çš„å›¾ç‰‡

### 4. å¯è§‚æµ‹æ€§
- **æ“ä½œæ—¥å¿—**ï¼šè¯¦ç»†è®°å½•æ‰€æœ‰å›¾ç‰‡æ“ä½œ
- **ç»Ÿè®¡æŠ¥è¡¨**ï¼šæä¾›å­˜å‚¨ä½¿ç”¨ç»Ÿè®¡å’Œä¼˜åŒ–å»ºè®®
- **å®¡è®¡åŠŸèƒ½**ï¼šæ”¯æŒå›¾ç‰‡æ“ä½œå®¡è®¡å’Œè¿½è¸ª

## ğŸ“‹ æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¼˜åŒ–ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

ğŸ¯ **å®Œæ•´çš„èµ„æºç®¡ç†é—­ç¯**
- åˆ›å»º â†’ æ³¨å†Œå¼•ç”¨
- æ›´æ–° â†’ åŠ¨æ€ç®¡ç†
- åˆ é™¤ â†’ æ™ºèƒ½æ¸…ç†

âš¡ **é«˜æ€§èƒ½å¤„ç†æœºåˆ¶**
- Redisé«˜æ•ˆç¼“å­˜
- å¼‚æ­¥å¤„ç†ä¸é˜»å¡
- æ™ºèƒ½ç®—æ³•å‡å°‘å¼€é”€

ğŸ” **å®‰å…¨å¯é çš„è®¾è®¡**
- æƒé™æ§åˆ¶ä¸¥æ ¼
- å¼‚å¸¸å¤„ç†å®Œå–„
- æ•°æ®ä¸€è‡´æ€§ä¿è¯

è¿™äº›ä¼˜åŒ–æ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ã€æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼Œä¸ºåç»­åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®åŸºç¡€ã€‚