# çŸ¥è¯†ç®¡ç†ç³»ç»Ÿ - å¤šç±»å‹çŸ¥è¯†æ”¯æŒ

## æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸ºçŸ¥è¯†ç®¡ç†ç³»ç»Ÿæ·»åŠ äº†å¯¹ä¸‰ç§ç±»å‹çŸ¥è¯†çš„æ”¯æŒï¼š
1. **æ–‡æ¡£çŸ¥è¯†** - Markdownæ ¼å¼çš„å¯Œæ–‡æœ¬æ–‡æ¡£
2. **å·¥å…·çŸ¥è¯†** - Agentå·¥å…·çš„å®šä¹‰å’Œç®¡ç†
3. **è¡¨å•çŸ¥è¯†** - åŠ¨æ€è¡¨å•ç»“æ„å®šä¹‰

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

é‡‡ç”¨**å¯æ‰©å±•çš„å•è¡¨å¤šæ€æ¨¡å¼**ï¼Œé€šè¿‡ `type_specific_data` JSONå­—æ®µå­˜å‚¨ä¸åŒç±»å‹çŸ¥è¯†çš„ç‰¹å®šæ•°æ®ï¼Œç¡®ä¿ï¼š
- **å¯æ‰©å±•æ€§**ï¼šæœªæ¥å¯è½»æ¾æ·»åŠ æ–°çš„çŸ¥è¯†ç±»å‹
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç»Ÿä¸€çš„åŸºç¡€æ¨¡å‹å’Œæƒé™ç®¡ç†
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…å¤šè¡¨å…³è”æŸ¥è¯¢çš„å¤æ‚æ€§

### æ•°æ®æ¨¡å‹æ¶æ„

```
KnowledgeDocument (åŸºç¡€æ¨¡å‹)
â”œâ”€â”€ é€šç”¨å­—æ®µï¼šid, title, namespace, creator, parent, etc.
â”œâ”€â”€ doc_typeï¼šæ–‡æ¡£ç±»å‹æ ‡è¯† ('document', 'tool', 'form', 'folder')
â””â”€â”€ type_specific_dataï¼šJSONå­—æ®µå­˜å‚¨ç±»å‹ç‰¹å®šæ•°æ®

FormDataEntry (è¡¨å•æ•°æ®æ¡ç›®)
â”œâ”€â”€ å…³è”è¡¨å•çŸ¥è¯†æ–‡æ¡£
â”œâ”€â”€ å­˜å‚¨ç”¨æˆ·æäº¤çš„è¡¨å•æ•°æ®
â””â”€â”€ è®°å½•æäº¤è€…å’Œæ—¶é—´

ToolExecution (å·¥å…·æ‰§è¡Œè®°å½•)
â”œâ”€â”€ å…³è”å·¥å…·çŸ¥è¯†æ–‡æ¡£
â”œâ”€â”€ è®°å½•å·¥å…·æ‰§è¡Œçš„è¾“å…¥è¾“å‡º
â””â”€â”€ è¿½è¸ªæ‰§è¡ŒçŠ¶æ€å’Œæ—¶é•¿
```

## è¯¦ç»†å®ç°

### 1. æ¨¡å‹å±‚æ‰©å±•

#### KnowledgeDocument æ¨¡å‹å¢å¼º

**æ–°å¢å­—æ®µï¼š**
```python
type_specific_data = models.JSONField(
    blank=True,
    null=True,
    verbose_name="ç±»å‹ç‰¹å®šæ•°æ®",
    help_text="å­˜å‚¨ä¸åŒçŸ¥è¯†ç±»å‹çš„ç‰¹å®šæ•°æ®ï¼ˆå·¥å…·é…ç½®ã€è¡¨å•é…ç½®ç­‰ï¼‰"
)
```

**æ–°å¢æ–¹æ³•ï¼š**
```python
# ç±»å‹åˆ¤æ–­å±æ€§
@property
def is_tool(self): return self.doc_type == 'tool'

@property  
def is_form(self): return self.doc_type == 'form'

# æ•°æ®æ“ä½œæ–¹æ³•
def get_tool_data(self): è·å–å·¥å…·çŸ¥è¯†æ•°æ®
def set_tool_data(self, data): è®¾ç½®å·¥å…·çŸ¥è¯†æ•°æ®
def get_form_data(self): è·å–è¡¨å•çŸ¥è¯†æ•°æ®
def set_form_data(self, data): è®¾ç½®è¡¨å•çŸ¥è¯†æ•°æ®
def get_dynamic_table_name(self): ç”Ÿæˆè¡¨å•å¯¹åº”çš„æ•°æ®è¡¨å
```

#### è¾…åŠ©æ¨¡å‹

**FormDataEntry - è¡¨å•æ•°æ®æ¡ç›®**
```python
- form_document: å…³è”çš„è¡¨å•çŸ¥è¯†æ–‡æ¡£
- data: ç”¨æˆ·æäº¤çš„è¡¨å•æ•°æ® (JSONField)
- submitter: æäº¤è€…
- created_at/updated_at: æ—¶é—´æˆ³
```

**ToolExecution - å·¥å…·æ‰§è¡Œè®°å½•**
```python
- tool_document: å…³è”çš„å·¥å…·çŸ¥è¯†æ–‡æ¡£
- executor: æ‰§è¡Œè€…
- input_data: è¾“å…¥å‚æ•° (JSONField)
- output_data: è¾“å‡ºç»“æœ (JSONField)
- status: æ‰§è¡ŒçŠ¶æ€ (pending/running/success/failed/cancelled)
- execution_time: æ‰§è¡Œè€—æ—¶
```

### 2. åºåˆ—åŒ–å™¨å±‚è®¾è®¡

#### ä¸“é—¨åŒ–åºåˆ—åŒ–å™¨

```python
KnowledgeDocumentToolSerializer    # å·¥å…·çŸ¥è¯†ä¸“ç”¨
KnowledgeDocumentFormSerializer    # è¡¨å•çŸ¥è¯†ä¸“ç”¨
ToolDataSerializer                 # å·¥å…·æ•°æ®éªŒè¯
FormDataSerializer                 # è¡¨å•æ•°æ®éªŒè¯
FormFieldSerializer               # è¡¨å•å­—æ®µéªŒè¯
```

#### æ™ºèƒ½åºåˆ—åŒ–å™¨é€‰æ‹©

```python
def get_serializer_class(self):
    """æ ¹æ®æ“ä½œå’Œæ–‡æ¡£ç±»å‹åŠ¨æ€é€‰æ‹©åºåˆ—åŒ–å™¨"""
    if self.action == 'create':
        doc_type = getattr(self.request, 'data', {}).get('doc_type', 'document')
        if doc_type == 'tool': return KnowledgeDocumentToolSerializer
        elif doc_type == 'form': return KnowledgeDocumentFormSerializer
    elif self.action in ['retrieve', 'update', 'partial_update']:
        instance = self.get_object()
        if instance.is_tool: return KnowledgeDocumentToolSerializer
        elif instance.is_form: return KnowledgeDocumentFormSerializer
    return KnowledgeDocumentDetailSerializer
```

### 3. è§†å›¾å±‚åŠŸèƒ½æ‰©å±•

#### æ–°å¢APIç«¯ç‚¹

**å·¥å…·çŸ¥è¯†ç›¸å…³ï¼š**
```
POST   /namespaces/{id}/documents/{doc_id}/execute_tool/     # æ‰§è¡Œå·¥å…·
GET    /namespaces/{id}/documents/{doc_id}/tool_executions/ # è·å–æ‰§è¡Œå†å²
```

**è¡¨å•çŸ¥è¯†ç›¸å…³ï¼š**
```
POST   /namespaces/{id}/documents/{doc_id}/submit_form_data/ # æäº¤è¡¨å•æ•°æ®
GET    /namespaces/{id}/documents/{doc_id}/form_data/        # è·å–è¡¨å•æ•°æ®
```

#### å¢å¼ºçš„é”™è¯¯å¤„ç†

```python
except serializers.ValidationError as e:
    # åºåˆ—åŒ–å™¨éªŒè¯é”™è¯¯ï¼Œè¿”å›400çŠ¶æ€ç 
    error_logger(f"åˆ›å»ºæ–‡æ¡£éªŒè¯å¤±è´¥: {str(e)}")
    return Response(e.detail, status=status.HTTP_400_BAD_REQUEST)
```

### 4. æ•°æ®ç»“æ„å®šä¹‰

#### å·¥å…·çŸ¥è¯†æ•°æ®ç»“æ„

```json
{
  "name": "å·¥å…·åç§°",
  "description": "å·¥å…·æè¿°",
  "input_schema": {
    "type": "object",
    "properties": {
      "ip_address": {"type": "string", "description": "IPåœ°å€"},
      "time": {"type": "string", "description": "ç”³è¯·æ—¶é•¿"}
    },
    "required": ["ip_address", "time"]
  },
  "few_shots": [
    "æˆ‘è¦ç”³è¯·ä¸€å°192.168.3.211çš„æœºå™¨,å‘¨æœŸ1ä¸ªæœˆã€‚",
    "jmsæ¥ä¸€å°æœºå™¨"
  ],
  "tool_type": "dynamic",
  "extra_params": {
    "code": "if not ip_address.startswith('192.168'): raise ToolException('IPåœ°å€ä¸åˆæ³•')"
  }
}
```

#### è¡¨å•çŸ¥è¯†æ•°æ®ç»“æ„

```json
{
  "table_name": "user_info",
  "table_description": "ç”¨æˆ·ä¿¡æ¯è¡¨",
  "fields": [
    {
      "name": "name",
      "field_type": "String",
      "description": "å§“å",
      "is_required": true,
      "default_value": ""
    },
    {
      "name": "age", 
      "field_type": "Integer",
      "description": "å¹´é¾„",
      "is_required": false,
      "default_value": "0"
    }
  ]
}
```

## æµ‹è¯•è¦†ç›–

### å®Œæ•´çš„æµ‹è¯•å¥—ä»¶

åˆ›å»ºäº† `test_knowledge_types.py` åŒ…å«14ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

**åŠŸèƒ½æµ‹è¯•ï¼š**
- âœ… åˆ›å»ºå·¥å…·çŸ¥è¯†
- âœ… åˆ›å»ºè¡¨å•çŸ¥è¯†  
- âœ… åˆ›å»ºæ–‡æ¡£çŸ¥è¯†
- âœ… æ›´æ–°å·¥å…·çŸ¥è¯†
- âœ… æ‰§è¡Œå·¥å…·
- âœ… æäº¤è¡¨å•æ•°æ®
- âœ… è·å–è¡¨å•æ•°æ®
- âœ… è·å–å·¥å…·æ‰§è¡Œå†å²

**éªŒè¯æµ‹è¯•ï¼š**
- âœ… æ— æ•ˆå·¥å…·è¾“å…¥æ¨¡å¼éªŒè¯
- âœ… æ— æ•ˆè¡¨å•å­—æ®µéªŒè¯

**æ¨¡å‹æµ‹è¯•ï¼š**
- âœ… å·¥å…·æ•°æ®æ–¹æ³•æµ‹è¯•
- âœ… è¡¨å•æ•°æ®æ–¹æ³•æµ‹è¯•
- âœ… åŠ¨æ€è¡¨åç”Ÿæˆæµ‹è¯•
- âœ… ä¿å­˜æ–¹æ³•åˆå§‹åŒ–é€»è¾‘æµ‹è¯•

## æ–‡ä»¶ç»“æ„å˜æ›´

```
api/backend_management/knowledge/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py                    # æ–°å¢ï¼šFormDataEntry, ToolExecution
â”‚   â””â”€â”€ knowledge_management.py       # æ‰©å±•ï¼štype_specific_dataå­—æ®µå’Œæ–¹æ³•
â”œâ”€â”€ serializers/
â”‚   â”œâ”€â”€ __init__.py                    # æ–°å¢ï¼šå¤šä¸ªä¸“é—¨åºåˆ—åŒ–å™¨
â”‚   â””â”€â”€ knowledge_management.py       # æ–°å¢ï¼šå·¥å…·å’Œè¡¨å•åºåˆ—åŒ–å™¨
â”œâ”€â”€ views/
â”‚   â””â”€â”€ knowledge_management.py       # æ‰©å±•ï¼šæ–°å¢APIç«¯ç‚¹å’Œæ™ºèƒ½åºåˆ—åŒ–å™¨é€‰æ‹©
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_knowledge_types.py       # æ–°å¢ï¼šå®Œæ•´æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 0006_*.py                      # æ–°å¢ï¼šæ•°æ®åº“è¿ç§»æ–‡ä»¶
â””â”€â”€ README_KNOWLEDGE_TYPES.md         # æ–°å¢ï¼šæœ¬æ–‡æ¡£
```

## APIä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºå·¥å…·çŸ¥è¯†

```bash
POST /api/knowledge/namespaces/{namespace_id}/documents/
Content-Type: application/json

{
  "title": "æœºå™¨ç”³è¯·å·¥å…·",
  "doc_type": "tool",
  "tool_data": {
    "name": "ç”³è¯·æœºå™¨",
    "description": "ç”¨äºç”³è¯·æœåŠ¡å™¨èµ„æºçš„å·¥å…·",
    "input_schema": {
      "type": "object",
      "properties": {
        "ip_address": {"type": "string", "description": "IPåœ°å€"},
        "duration": {"type": "string", "description": "ç”³è¯·æ—¶é•¿"}
      },
      "required": ["ip_address", "duration"]
    },
    "few_shots": ["æˆ‘è¦ç”³è¯·192.168.1.100çš„æœºå™¨ï¼Œæ—¶é•¿1ä¸ªæœˆ"],
    "tool_type": "dynamic",
    "extra_params": {
      "code": "# å·¥å…·æ‰§è¡Œä»£ç "
    }
  }
}
```

### 2. åˆ›å»ºè¡¨å•çŸ¥è¯†

```bash
POST /api/knowledge/namespaces/{namespace_id}/documents/
Content-Type: application/json

{
  "title": "ç”¨æˆ·ä¿¡æ¯æ”¶é›†è¡¨",
  "doc_type": "form", 
  "form_data": {
    "table_name": "user_survey",
    "table_description": "ç”¨æˆ·è°ƒç ”ä¿¡æ¯æ”¶é›†",
    "fields": [
      {
        "name": "name",
        "field_type": "String",
        "description": "å§“å",
        "is_required": true
      },
      {
        "name": "age",
        "field_type": "Integer", 
        "description": "å¹´é¾„",
        "is_required": false,
        "default_value": "0"
      }
    ]
  }
}
```

### 3. æ‰§è¡Œå·¥å…·

```bash
POST /api/knowledge/namespaces/{namespace_id}/documents/{tool_id}/execute_tool/
Content-Type: application/json

{
  "input_data": {
    "ip_address": "192.168.1.100",
    "duration": "1ä¸ªæœˆ"
  }
}
```

### 4. æäº¤è¡¨å•æ•°æ®

```bash
POST /api/knowledge/namespaces/{namespace_id}/documents/{form_id}/submit_form_data/
Content-Type: application/json

{
  "data": {
    "name": "å¼ ä¸‰",
    "age": 25
  }
}
```

## æ€§èƒ½è€ƒè™‘

### æ•°æ®åº“ä¼˜åŒ–

```python
# æ·»åŠ çš„ç´¢å¼•
indexes = [
    models.Index(fields=['namespace', 'doc_type']),  # æŒ‰ç±»å‹æŸ¥è¯¢ä¼˜åŒ–
    models.Index(fields=['tool_document', 'status']), # å·¥å…·æ‰§è¡ŒçŠ¶æ€æŸ¥è¯¢
    models.Index(fields=['form_document', 'created_at']), # è¡¨å•æ•°æ®æ—¶é—´æŸ¥è¯¢
]
```

### æŸ¥è¯¢ä¼˜åŒ–

```python
# ä½¿ç”¨select_relatedå‡å°‘æ•°æ®åº“æŸ¥è¯¢
queryset = KnowledgeDocument.objects.filter(
    namespace=namespace,
    is_active=True
).select_related('creator', 'last_editor', 'parent')
```

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„çŸ¥è¯†ç±»å‹

1. **æ‰©å±•TYPE_CHOICES**ï¼š
```python
TYPE_CHOICES = [
    ('folder', 'æ–‡ä»¶å¤¹'),
    ('document', 'æ–‡æ¡£'),
    ('tool', 'å·¥å…·'),
    ('form', 'è¡¨å•'),
    ('new_type', 'æ–°ç±»å‹'),  # æ·»åŠ æ–°ç±»å‹
]
```

2. **æ·»åŠ ç±»å‹åˆ¤æ–­å±æ€§**ï¼š
```python
@property
def is_new_type(self):
    return self.doc_type == 'new_type'
```

3. **æ‰©å±•é»˜è®¤æ•°æ®ç»“æ„**ï¼š
```python
def _get_default_type_data(self):
    if self.doc_type == 'new_type':
        return {'field1': 'value1', 'field2': 'value2'}
    # ... å…¶ä»–ç±»å‹
```

4. **åˆ›å»ºä¸“é—¨åºåˆ—åŒ–å™¨**ï¼š
```python
class KnowledgeDocumentNewTypeSerializer(KnowledgeDocumentDetailSerializer):
    new_type_data = NewTypeDataSerializer(required=False)
    # ... å®ç°å…·ä½“é€»è¾‘
```

5. **æ›´æ–°è§†å›¾é€‰æ‹©é€»è¾‘**ï¼š
```python
def get_serializer_class(self):
    # ... ç°æœ‰é€»è¾‘
    elif doc_type == 'new_type':
        return KnowledgeDocumentNewTypeSerializer
```

## åç»­ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜ä¼˜åŒ–
- ä¸ºé¢‘ç¹è®¿é—®çš„çŸ¥è¯†æ–‡æ¡£æ·»åŠ Redisç¼“å­˜
- å®ç°å·¥å…·æ‰§è¡Œç»“æœçš„ç¼“å­˜æœºåˆ¶

### 2. æƒé™ç»†åŒ–
- å®ç°åŸºäºçŸ¥è¯†ç±»å‹çš„æƒé™æ§åˆ¶
- æ·»åŠ å·¥å…·æ‰§è¡Œæƒé™ç®¡ç†

### 3. å·¥å…·æ‰§è¡Œå¼•æ“
- å®ç°å®é™…çš„å·¥å…·ä»£ç æ‰§è¡Œç¯å¢ƒ
- æ·»åŠ å®‰å…¨æ²™ç®±å’Œèµ„æºé™åˆ¶

### 4. è¡¨å•æ•°æ®å¤„ç†
- å®ç°åŠ¨æ€PostgreSQLè¡¨åˆ›å»º
- æ·»åŠ è¡¨å•æ•°æ®çš„ç»Ÿè®¡å’Œåˆ†æåŠŸèƒ½

### 5. APIæ–‡æ¡£å®Œå–„
- ä½¿ç”¨OpenAPI 3.0è§„èŒƒå®Œå–„APIæ–‡æ¡£
- æ·»åŠ äº¤äº’å¼APIæµ‹è¯•ç•Œé¢

## æ€»ç»“

æœ¬æ¬¡å®ç°æˆåŠŸä¸ºçŸ¥è¯†ç®¡ç†ç³»ç»Ÿæ·»åŠ äº†å¯¹å¤šç§çŸ¥è¯†ç±»å‹çš„æ”¯æŒï¼Œé‡‡ç”¨äº†å¯æ‰©å±•çš„æ¶æ„è®¾è®¡ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚é€šè¿‡å®Œå–„çš„æµ‹è¯•è¦†ç›–å’Œè¯¦ç»†çš„æ–‡æ¡£ï¼Œä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

**æ ¸å¿ƒäº®ç‚¹ï¼š**
- ğŸ—ï¸ **å¯æ‰©å±•æ¶æ„**ï¼šå•è¡¨å¤šæ€è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°ç±»å‹
- ğŸ”’ **å®Œæ•´æƒé™ç®¡ç†**ï¼šç»§æ‰¿ç°æœ‰æƒé™ä½“ç³»ï¼Œç¡®ä¿å®‰å…¨æ€§
- ğŸ“Š **ä¸°å¯Œæ•°æ®ç»“æ„**ï¼šæ”¯æŒå¤æ‚çš„å·¥å…·å’Œè¡¨å•å®šä¹‰
- ğŸ§ª **å®Œå–„æµ‹è¯•è¦†ç›–**ï¼š14ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- ğŸ“– **è¯¦ç»†æ–‡æ¡£**ï¼šå®Œæ•´çš„ä½¿ç”¨æŒ‡å—å’Œæ‰©å±•è¯´æ˜

è¿™ä¸ªå®ç°ä¸ºAIåŸç”Ÿå¹³å°çš„çŸ¥è¯†ç®¡ç†æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„åŸºç¡€è®¾æ–½ã€‚ 