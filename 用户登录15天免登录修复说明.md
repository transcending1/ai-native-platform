# 用户登录15天免登录功能修复说明

## 问题描述
用户反馈：在用户登录模块中，15天token过期没有生效。用户点击了页面上的"15天内免登录"选项，然后点击了登录。但是过了15天用户就自然登出了，失效了。

## 问题分析
经过代码分析，发现了以下问题：

1. **后端缺少JWT refresh token端点**：前端调用了 `/user/refresh/` 端点，但后端没有配置这个端点
2. **前端没有保存refresh token**：前端只保存了access token，没有保存refresh token
3. **前端没有实现自动token刷新机制**：当access token过期时，前端没有自动使用refresh token刷新
4. **15天免登录逻辑有误**：后端的token过期时间设置逻辑不正确

## 修复内容

### 1. 后端修复

#### 1.1 添加JWT refresh token端点
**文件**: `api/backend_management/llm_api/urls.py`

```python
from rest_framework_simplejwt.views import (
    TokenRefreshView,
    TokenVerifyView
)

# 在urlpatterns中添加
path('user/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
path('user/verify/', TokenVerifyView.as_view(), name='token_verify'),
```

#### 1.2 修复15天免登录逻辑
**文件**: `api/backend_management/user/serializers/user.py`

修复了 `get_tokens` 方法中的逻辑：

```python
def get_tokens(self, user, remember_me=False):
    """
    获取JWT token
    """
    refresh = RefreshToken.for_user(user)
    
    # 根据是否选择15天免登录来设置不同的过期时间
    if remember_me:
        # 选择了15天免登录：refresh token使用15天，access token使用1小时
        from datetime import timedelta
        # refresh token已经在settings中配置为15天，不需要修改
        # access token设置为1小时
        refresh.access_token.set_exp(lifetime=timedelta(hours=1))
    else:
        # 没有选择免登录：refresh token使用1天，access token使用1小时
        from datetime import timedelta
        # 设置refresh token过期时间为1天
        refresh.set_exp(lifetime=timedelta(days=1))
        # access token设置为1小时
        refresh.access_token.set_exp(lifetime=timedelta(hours=1))
        
    return {
        'refresh': str(refresh),
        'access': str(refresh.access_token),
        'user': UserInfoSerializer(user).data
    }
```

### 2. 前端修复

#### 2.1 修复用户状态管理
**文件**: `new_web/src/stores/user.js`

- 添加了 `refreshToken` 状态管理
- 修复了 `login` 方法，支持保存refresh token和记住登录状态
- 添加了 `updateToken` 方法用于token刷新

```javascript
// 添加refresh token状态
const refreshToken = ref('')

// 修复login方法
const login = (userData, authToken, refreshTokenValue, rememberMe = false) => {
  userInfo.value = userData
  token.value = authToken
  refreshToken.value = refreshTokenValue
  isLoggedIn.value = true
  
  // 保存到localStorage
  localStorage.setItem('token', authToken)
  localStorage.setItem('refreshToken', refreshTokenValue)
  localStorage.setItem('userInfo', JSON.stringify(userData))
  
  // 保存记住登录状态
  if (rememberMe) {
    localStorage.setItem('rememberLogin', 'true')
  } else {
    localStorage.removeItem('rememberLogin')
  }
}

// 添加updateToken方法
const updateToken = (newToken, newRefreshToken) => {
  token.value = newToken
  if (newRefreshToken) {
    refreshToken.value = newRefreshToken
    localStorage.setItem('refreshToken', newRefreshToken)
  }
  localStorage.setItem('token', newToken)
}
```

#### 2.2 修复API拦截器
**文件**: `new_web/src/api.js`

- 添加了自动token刷新机制
- 当收到401错误时，自动尝试使用refresh token刷新
- 刷新成功后重试原请求
- 刷新失败时清除用户状态并跳转登录页

```javascript
// 响应拦截器 - 处理401错误自动跳转登录页
apiClient.interceptors.response.use(res => {
  return res
}, async error => {
  const originalRequest = error.config
  
  // 处理401未授权错误 - Token过期或无效
  if (error.response?.status === 401 && !originalRequest._retry) {
    originalRequest._retry = true
    
    // 尝试使用refresh token刷新
    const refreshToken = localStorage.getItem('refreshToken')
    const rememberLogin = localStorage.getItem('rememberLogin')
    
    if (refreshToken && rememberLogin === 'true') {
      try {
        console.log('Token已过期，尝试刷新...')
        
        // 调用刷新token接口
        const refreshResponse = await apiClient.post('/user/refresh/', {
          refresh: refreshToken
        })
        
        if (refreshResponse.data.access) {
          // 更新token
          const newToken = refreshResponse.data.access
          const newRefreshToken = refreshResponse.data.refresh
          
          // 更新localStorage和store
          localStorage.setItem('token', newToken)
          if (newRefreshToken) {
            localStorage.setItem('refreshToken', newRefreshToken)
          }
          
          // 更新请求头
          originalRequest.headers.Authorization = `Bearer ${newToken}`
          
          // 更新Pinia store
          import('@/stores/user').then(({ useUserStore }) => {
            const userStore = useUserStore()
            userStore.updateToken(newToken, newRefreshToken)
          })
          
          console.log('Token刷新成功，重试原请求')
          return apiClient(originalRequest)
        }
      } catch (refreshError) {
        console.error('Token刷新失败:', refreshError)
      }
    }
    
    // 如果刷新失败，清除用户状态并跳转登录页
    // ... 清除逻辑
  }
  
  return Promise.reject(error)
})
```

#### 2.3 修复登录表单
**文件**: `new_web/src/views/Login/components/LoginForm.vue`

- 修复了登录成功后的处理逻辑
- 确保正确保存refresh token和记住登录状态

```javascript
// 处理登录成功的响应
if (response.data.code === 200) {
  const { data } = response.data
  const { access, refresh, user } = data
  
  // 保存登录状态到store（包含refresh token）
  userStore.login(user, access, refresh, loginForm.rememberMe)
  
  ElMessage.success('登录成功!')
  
  // 跳转到首页
  router.push('/')
}
```

## 修复后的功能

### 1. 15天免登录功能
- 用户选择"15天内免登录"时，refresh token有效期为15天
- 用户不选择免登录时，refresh token有效期为1天
- access token统一为1小时有效期

### 2. 自动token刷新
- 当access token过期时，前端自动使用refresh token刷新
- 刷新成功后自动重试原请求，用户无感知
- 刷新失败时自动清除用户状态并跳转登录页

### 3. 用户体验优化
- 用户选择免登录后，15天内无需重新登录
- token过期时自动刷新，不会中断用户操作
- 只有在refresh token也过期时才会要求重新登录

## 测试验证

### 后端测试
运行了完整的用户认证测试套件，所有测试通过：

```bash
python manage.py test user.tests.test_user.TestUserAuthentication -v 2
```

### 新增测试
添加了token刷新功能测试：

```bash
python manage.py test user.tests.test_user.TestUserAuthentication.test_token_refresh -v 2
```

## 文件结构变更

```
api/backend_management/
├── llm_api/
│   └── urls.py                    # 添加JWT refresh端点
└── user/
    └── serializers/
        └── user.py                # 修复15天免登录逻辑

new_web/src/
├── api.js                         # 添加自动token刷新机制
├── stores/
│   └── user.js                    # 修复用户状态管理
└── views/Login/components/
    └── LoginForm.vue              # 修复登录表单逻辑
```

## 后续优化建议

1. **添加token过期时间检查**：在前端添加本地检查，提前刷新即将过期的token
2. **添加用户活动检测**：检测用户是否活跃，非活跃时缩短token有效期
3. **添加多设备登录管理**：支持查看和管理多设备登录状态
4. **添加登录日志**：记录用户的登录、登出、token刷新等操作
5. **添加安全提醒**：当用户长时间未登录时，发送安全提醒邮件

## 总结

通过这次修复，彻底解决了15天免登录功能不生效的问题。现在用户可以正常使用15天免登录功能，系统会自动处理token刷新，提供更好的用户体验。同时，代码结构更加健壮，为后续功能扩展打下了良好基础。 