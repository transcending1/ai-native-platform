<template>
  <div>
    <!-- Êìç‰ΩúÊ†è -->
    <div class="flex justify-end items-center gap-4 mb-6">
      <!-- ÊêúÁ¥¢Ê°Ü -->
      <el-input
        v-model="searchKeyword"
        placeholder="ÊêúÁ¥¢Ê®°ÂûãID"
        size="default"
        style="width: 250px"
        clearable
        @change="handleSearch"
      >
        <template #prefix>
          <el-icon><Search /></el-icon>
        </template>
      </el-input>
      
      <!-- Êñ∞Âª∫ÊåâÈíÆ -->
      <el-button 
        type="primary" 
        size="default"
        @click="showCreateDialog = true"
        class="flex items-center gap-2"
      >
        <span>+</span>
        Êñ∞Âª∫LLMÊ®°Âûã
      </el-button>
    </div>

    <!-- Ê®°ÂûãÂàóË°® -->
    <div v-loading="loading">
      <div v-if="models.length === 0 && !loading" class="text-center py-12">
        <div class="text-gray-400 text-lg mb-4">ÊöÇÊó†LLMÊ®°Âûã</div>
        <el-button type="primary" @click="showCreateDialog = true">
          ÂàõÂª∫ÊÇ®ÁöÑÁ¨¨‰∏Ä‰∏™LLMÊ®°Âûã
        </el-button>
      </div>
      
      <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div
          v-for="model in models"
          :key="model.id"
          class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200"
        >
          <!-- Ê®°ÂûãÂ∞ÅÈù¢ -->
          <div class="relative h-32 bg-gradient-to-br from-orange-50 to-red-100 rounded-t-lg overflow-hidden">
            <div class="flex items-center justify-center h-full">
              <span class="text-3xl">ü§ñ</span>
            </div>
            
            <!-- Êìç‰ΩúËèúÂçï -->
            <div class="absolute top-3 right-3">
              <el-dropdown @command="handleAction" trigger="click">
                <el-button 
                  size="small" 
                  circle 
                  :icon="MoreFilled" 
                  class="bg-white/80 hover:bg-white border-0 shadow-sm"
                />
                <template #dropdown>
                  <el-dropdown-menu>
                    <el-dropdown-item :command="{action: 'edit', data: model}">
                      <el-icon><Edit /></el-icon>
                      ÁºñËæë
                    </el-dropdown-item>
                    <el-dropdown-item :command="{action: 'delete', data: model}" divided class="text-red-600">
                      <el-icon><Delete /></el-icon>
                      Âà†Èô§
                    </el-dropdown-item>
                  </el-dropdown-menu>
                </template>
              </el-dropdown>
            </div>
          </div>

          <!-- Ê®°Âûã‰ø°ÊÅØ -->
          <div class="p-4">
            <div class="flex items-start justify-between mb-2">
              <h3 class="text-lg font-semibold text-gray-900 line-clamp-1">
                {{ model.model_id }}
              </h3>
            </div>
            
            <p class="text-gray-600 text-sm mb-3 line-clamp-2">
              {{ getProviderLabel(model.provider) }}
            </p>
            
            
            <!-- Áä∂ÊÄÅÊ†áÁ≠æ -->
            <div class="flex items-center justify-between mb-3">
              <el-tag 
                :type="model.is_active ? 'success' : 'info'"
                size="small"
              >
                {{ model.is_active ? 'ÂêØÁî®' : 'Á¶ÅÁî®' }}
              </el-tag>
              <span class="text-xs text-gray-500">
                {{ formatDate(model.updated_at) }}
              </span>
            </div>
            
            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="flex justify-end gap-2">
              <el-button 
                type="success" 
                size="small"
                @click="handleTest(model)"
                :loading="testingModel === model.id"
              >
                ÊµãËØïÊ®°Âûã
              </el-button>
              <el-button 
                type="primary" 
                size="small"
                @click="handleEdit(model)"
              >
                ÁºñËæëÊ®°Âûã
              </el-button>
            </div>
          </div>
        </div>
      </div>

      <!-- ÂàÜÈ°µ -->
      <div v-if="total > pageSize" class="flex justify-center mt-8">
        <el-pagination
          v-model:current-page="currentPage"
          :page-size="pageSize"
          :total="total"
          layout="prev, pager, next, jumper"
          @current-change="loadModels"
        />
      </div>
    </div>

    <!-- ÂàõÂª∫/ÁºñËæëÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="showCreateDialog"
      :title="editingModel ? 'ÁºñËæëLLMÊ®°Âûã' : 'ÂàõÂª∫LLMÊ®°Âûã'"
      width="600px"
    >
      <el-form 
        ref="formRef"
        :model="formData"
        :rules="formRules"
        label-width="100px"
      >
        <el-form-item label="Ê®°ÂûãID" prop="model_id">
          <el-input
            v-model="formData.model_id"
            placeholder="ËØ∑ËæìÂÖ•Ê®°ÂûãID"
            maxlength="100"
          />
        </el-form-item>
        
        <el-form-item label="Êèê‰æõÂïÜ" prop="provider">
          <el-select
            v-model="formData.provider"
            placeholder="ËØ∑ÈÄâÊã©Êèê‰æõÂïÜ"
            style="width: 100%"
            filterable
          >
            <el-option
              v-for="provider in providers"
              :key="provider.value"
              :label="provider.label"
              :value="provider.value"
            />
          </el-select>
        </el-form-item>
        
        <el-form-item label="APIÂØÜÈí•" prop="api_key">
          <el-input
            v-model="formData.api_key"
            type="password"
            placeholder="ËØ∑ËæìÂÖ•APIÂØÜÈí•"
            maxlength="255"
            show-password
          />
        </el-form-item>
        
        <el-form-item label="APIÂü∫Á°ÄURL" prop="api_base">
          <el-input
            v-model="formData.api_base"
            placeholder="ËØ∑ËæìÂÖ•APIÂü∫Á°ÄURL"
            maxlength="255"
          />
        </el-form-item>
        
        <el-form-item label="ÊòØÂê¶ÂêØÁî®" prop="is_active">
          <el-switch
            v-model="formData.is_active"
            active-text="ÂêØÁî®"
            inactive-text="Á¶ÅÁî®"
          />
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="showCreateDialog = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="handleSubmit" :loading="submitting">
          {{ editingModel ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫' }}
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Search, Setting, Edit, Delete, MoreFilled } from '@element-plus/icons-vue'
import { providerAPI } from '@/api.js'

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const loading = ref(false)
const models = ref([])
const total = ref(0)
const currentPage = ref(1)
const pageSize = ref(12)
const searchKeyword = ref('')

// ÂØπËØùÊ°ÜÊéßÂà∂
const showCreateDialog = ref(false)
const editingModel = ref(null)
const submitting = ref(false)

// Êèê‰æõÂïÜÂàóË°®
const providers = ref([])
const testingModel = ref(null)

// Ë°®ÂçïÊï∞ÊçÆ
const formRef = ref()
const formData = ref({
  model_id: '',
  provider: '',
  api_key: '',
  api_base: '',
  is_active: true
})

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const formRules = {
  model_id: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Ê®°ÂûãID', trigger: 'blur' },
    { min: 1, max: 100, message: 'Ê®°ÂûãIDÈïøÂ∫¶Âú®1Âà∞100‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  provider: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Êèê‰æõÂïÜ', trigger: 'change' }
  ]
}

// Ê†ºÂºèÂåñÊó•Êúü
const formatDate = (dateString) => {
  const date = new Date(dateString)
  return date.toLocaleDateString('zh-CN')
}

// Ëé∑ÂèñÊèê‰æõÂïÜÊ†áÁ≠æ
const getProviderLabel = (providerValue) => {
  const provider = providers.value.find(p => p.value === providerValue)
  return provider ? provider.label : providerValue
}

// Âä†ËΩΩÊ®°ÂûãÂàóË°®
const loadModels = async (page = 1) => {
  loading.value = true
  try {
    const params = {
      page,
      model_id: searchKeyword.value || undefined
    }
    
    const response = await providerAPI.getLLMModels(params)
    // Ê†πÊçÆÂêéÁ´ØËøîÂõûÁöÑÊï∞ÊçÆÁªìÊûÑÔºåÊï∞ÊçÆÂú® response.data.data ‰∏≠
    models.value = response.data.data.results || []
    total.value = response.data.data.count || 0
    currentPage.value = page
  } catch (error) {
    console.error('Ëé∑ÂèñLLMÊ®°ÂûãÂàóË°®Â§±Ë¥•:', error)
    ElMessage.error('Ëé∑ÂèñLLMÊ®°ÂûãÂàóË°®Â§±Ë¥•')
  } finally {
    loading.value = false
  }
}

// ÊêúÁ¥¢Â§ÑÁêÜ
const handleSearch = () => {
  currentPage.value = 1
  loadModels(1)
}

// Â§ÑÁêÜÊìç‰ΩúËèúÂçï
const handleAction = ({ action, data }) => {
  switch (action) {
    case 'edit':
      handleEdit(data)
      break
    case 'delete':
      handleDelete(data)
      break
  }
}

// Â§ÑÁêÜÁºñËæë
const handleEdit = (model) => {
  editingModel.value = model
  formData.value = {
    model_id: model.model_id,
    provider: model.provider,
    api_key: model.api_key || '',
    api_base: model.api_base || '',
    is_active: model.is_active
  }
  showCreateDialog.value = true
}

// Â§ÑÁêÜÂà†Èô§
const handleDelete = async (model) => {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂà†Èô§LLMÊ®°Âûã "${model.model_id}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
      'Âà†Èô§Á°ÆËÆ§',
      {
        confirmButtonText: 'Á°ÆÂÆöÂà†Èô§',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning',
        confirmButtonClass: 'el-button--danger'
      }
    )
    
    await providerAPI.deleteLLMModel(model.id)
    ElMessage.success('Âà†Èô§ÊàêÂäü')
    loadModels(currentPage.value)
  } catch (error) {
    if (error !== 'cancel') {
      console.error('Âà†Èô§Â§±Ë¥•:', error)
      ElMessage.error('Âà†Èô§Â§±Ë¥•')
    }
  }
}

// Â§ÑÁêÜË°®ÂçïÊèê‰∫§
const handleSubmit = async () => {
  try {
    await formRef.value.validate()
    
    submitting.value = true
    
    if (editingModel.value) {
      // Êõ¥Êñ∞
      await providerAPI.updateLLMModel(editingModel.value.id, formData.value)
      ElMessage.success('Êõ¥Êñ∞ÊàêÂäü')
    } else {
      // ÂàõÂª∫
      await providerAPI.createLLMModel(formData.value)
      ElMessage.success('ÂàõÂª∫ÊàêÂäü')
    }
    
    showCreateDialog.value = false
    loadModels(currentPage.value)
  } catch (error) {
    if (error !== 'cancel') {
      console.error('Êèê‰∫§Â§±Ë¥•:', error)
      ElMessage.error('Êèê‰∫§Â§±Ë¥•')
    }
  } finally {
    submitting.value = false
  }
}

// Âä†ËΩΩÊèê‰æõÂïÜÂàóË°®
const loadProviders = async () => {
  try {
    const response = await providerAPI.getLLMProviders()
    providers.value = response.data.data || []
  } catch (error) {
    console.error('Ëé∑ÂèñÊèê‰æõÂïÜÂàóË°®Â§±Ë¥•:', error)
    ElMessage.error('Ëé∑ÂèñÊèê‰æõÂïÜÂàóË°®Â§±Ë¥•')
  }
}

// Â§ÑÁêÜÊµãËØïÊ®°Âûã
const handleTest = async (model) => {
  try {
    testingModel.value = model.id
    
    const response = await providerAPI.testLLMModel(model.id)
    
    ElMessage.success('Ê®°ÂûãÊµãËØïÊàêÂäü')
    
    // ÊòæÁ§∫ÊµãËØïÁªìÊûú
    ElMessageBox.alert(
      `ÊµãËØïÊó∂Èó¥: ${response.data.data.test_time}\n\nÂìçÂ∫îÂÜÖÂÆπ:\n${response.data.data.response}`,
      'ÊµãËØïÁªìÊûú',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        type: 'success',
        dangerouslyUseHTMLString: false
      }
    )
  } catch (error) {
    console.error('ÊµãËØïÊ®°ÂûãÂ§±Ë¥•:', error)
    ElMessage.error(error.response?.data?.message || 'ÊµãËØïÊ®°ÂûãÂ§±Ë¥•')
  } finally {
    testingModel.value = null
  }
}

// È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
onMounted(() => {
  loadModels()
  loadProviders()
})
</script>

<style scoped>
.line-clamp-1 {
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style> 